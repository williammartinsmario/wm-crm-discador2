<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>WM CRM & Discador</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Poppins',sans-serif;background:#f4f6f9;color:#333}
header{display:flex;align-items:center;gap:12px;padding:12px 20px;background:#fff;border-bottom:2px solid #e5e7eb}
header img{height:44px}
header h1{font-size:20px;color:#003366;font-weight:600;margin:0}
.btn{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border:none;border-radius:8px;font-weight:600;font-size:13px;cursor:pointer;transition:.2s}
.btn:hover{opacity:.9;transform:translateY(-1px)}
.btn-primary{background:#007bff;color:#fff}
.btn-light{background:#f1f3f5;color:#333}
.btn-success{background:#25D366;color:#fff}
.btn-danger{background:#dc3545;color:#fff}
.btn-warning{background:#ffc107;color:#000}
.btn-info{background:#17a2b8;color:#fff}
#top-bar{display:flex;flex-wrap:wrap;gap:8px;padding:8px 20px;background:#fafafa;border-bottom:1px solid #ddd}
#kanbanBoard{display:flex;gap:10px;padding:10px;overflow-x:auto}
.kanban-column{background:#fff;border-radius:8px;padding:6px;min-width:220px;max-height:calc(100vh - 250px);overflow-y:auto;box-shadow:0 1px 3px rgba(0,0,0,.08)}
.kanban-column h3{font-size:13px;margin:0 0 4px;color:#003366}
.card{background:#f9f9f9;border-radius:6px;padding:6px;margin-bottom:6px;font-size:12px;box-shadow:0 1px 2px rgba(0,0,0,.05)}
.card textarea{width:100%;margin-top:4px;font-size:11px;border-radius:4px}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:2000;padding:12px}
.modal-content{background:#fff;border-radius:8px;padding:16px;width:90%;max-width:400px}
.modal-content h3{margin:0 0 6px;color:#003366;font-size:16px}
footer{margin-top:20px;padding:10px;text-align:center;background:#003366;color:#fff;font-size:12px}
/* Etapas modal */
#etapasLista div{display:flex;gap:6px;align-items:center;margin-bottom:6px}
#etapasLista input{flex:1;padding:4px 6px;font-size:12px;border:1px solid #ccc;border-radius:6px}
.badge-alerta{background:#ffc107;color:#000;padding:0 4px;border-radius:4px;font-size:10px;margin-left:4px}
</style>
</head>
<body>
<header>
<img src="logo.png" alt="Logo">
<h1>WM CRM & Discador</h1>
</header>

<div id="top-bar">
<input type="file" id="csvInput" accept=".csv" class="btn-light">
<button class="btn-primary" id="btnPaste">üìã Colar Contatos</button>
<button class="btn-info" id="btnEtapas">‚öôÔ∏è Etapas</button>
<input type="text" id="search" placeholder="üîç Buscar nome">
</div>

<div id="kanbanBoard"></div>

<!-- Modal Paste -->
<div class="modal" id="modalPaste">
  <div class="modal-content">
    <h3>Colar contatos</h3>
    <textarea id="pasteText" rows="8" style="width:100%;"></textarea>
    <div id="pastePreview" style="background:#f1f3f5;border-radius:6px;padding:6px;font-size:11px;max-height:100px;overflow:auto;margin-top:6px"></div>
    <div style="display:flex;gap:6px;justify-content:flex-end;margin-top:8px">
      <button class="btn-danger" id="pasteCancel">Cancelar</button>
      <button class="btn-success" id="pasteSave" disabled>Salvar</button>
    </div>
  </div>
</div>

<!-- Modal Etapas -->
<div class="modal" id="modalEtapas">
  <div class="modal-content">
    <h3>Gerenciar etapas</h3>
    <div id="etapasLista"></div>
    <button class="btn-light" id="btnNovaEtapa" style="margin-bottom:8px">‚ûï Nova Etapa</button>
    <div style="display:flex;gap:6px;justify-content:flex-end">
      <button class="btn-danger" id="etapasCancel">Cancelar</button>
      <button class="btn-success" id="etapasSave">Salvar</button>
    </div>
  </div>
</div>

<!-- Modal Agendar -->
<div class="modal" id="modalAgendar">
  <div class="modal-content">
    <h3>Agendar visita</h3>
    <select id="agendaProjeto" style="width:100%;margin-bottom:6px">
      <option value="">-- selecionar projeto --</option>
      <option value="central">Central de Vendas ‚Äì Parque Prado</option>
      <option value="seleto">Seleto Amoreiras</option>
      <option value="mangara">Mangar√° ‚Äì Cores da Mata</option>
      <option value="alentejo">Alentejo Residencial</option>
      <option value="algarve">Algarve Residencial</option>
      <option value="rise">Rise Condom√≠nio Clube</option>
    </select>
    <input type="datetime-local" id="agendaData" style="width:100%;margin-bottom:6px">
    <textarea id="agendaMsg" rows="8" style="width:100%;"></textarea>
    <div style="display:flex;gap:6px;justify-content:flex-end;margin-top:8px">
      <button class="btn-danger" id="agendaCancel">Cancelar</button>
      <button class="btn-success" id="agendaSend">Enviar WhatsApp</button>
    </div>
  </div>
</div>

<footer>¬© 2025 WM Assessoria</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script>
/* ---------- Storage scoped per device ---------- */
const UID = localStorage.getItem('wm_uid') || (localStorage.setItem('wm_uid','uid_'+Math.random().toString(36).substr(2,9)),localStorage.getItem('wm_uid'));
const LS_STAGE = 'stages_'+UID;
const LS_LEADS = 'leads_'+UID;

/* ---------- Default stages ---------- */
let stages = JSON.parse(localStorage.getItem(LS_STAGE)) || [
  {id:'novo',label:'üì• Novo'},
  {id:'atendimento',label:'üìû Em Atendimento'},
  {id:'aguardando',label:'‚è≥ Aguardando'},
  {id:'fechado',label:'‚úÖ Fechado'}
];
let leads = JSON.parse(localStorage.getItem(LS_LEADS)) || [];

/* ---------- Utility ---------- */
const saveStages=()=>localStorage.setItem(LS_STAGE,JSON.stringify(stages));
const saveLeads =()=>localStorage.setItem(LS_LEADS,JSON.stringify(leads));
const slug=t=>t.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-');

/* ---------- Render Kanban ---------- */
function renderKanban(){
  const board=document.getElementById('kanbanBoard'); board.innerHTML='';
  stages.forEach(s=>{
    const col=document.createElement('div'); col.className='kanban-column'; col.id=s.id;
    col.innerHTML='<h3>'+s.label+'</h3>'; board.appendChild(col);
    new Sortable(col,{group:'kanban',animation:150,onEnd:e=>{
      const nome=e.item.dataset.nome; const l=leads.find(x=>x.nome===nome); if(l){l.status=s.id;saveLeads();}
    }});
  });
  leads.forEach(l=>{
    const col=document.getElementById(l.status)||document.getElementById(stages[0].id);
    const card=document.createElement('div'); card.className='card'; card.dataset.nome=l.nome;
    card.innerHTML=\`
      <strong>\${l.nome}</strong>
      <div>\${l.numero}</div>
      <textarea onchange="updateObs('\${l.nome}',this.value)">\${l.obs||''}</textarea>
      <div style="display:flex;gap:4px;margin-top:4px">
        <button class="btn btn-primary" onclick="openAgenda('\${l.nome}')">üìÖ</button>
        <button class="btn btn-danger" onclick="delLead('\${l.nome}')">‚ùå</button>
      </div>\`;
    col.appendChild(card);
  });
}
/* ---------- Leads actions ---------- */
function delLead(n){ if(confirm('Excluir lead?')){ leads=leads.filter(x=>x.nome!==n);saveLeads();renderKanban(); } }
function updateObs(n,v){ const l=leads.find(x=>x.nome===n); if(l){l.obs=v;saveLeads();} }
function openAgenda(n){ window.currentLead=n; agendaProjeto.value=''; agendaData.value=''; agendaMsg.value=''; modalAgendar.style.display='flex'; }
/* ---------- CSV ---------- */
csvInput.onchange=e=>{
  const f=e.target.files[0]; if(!f)return;
  const r=new FileReader(); r.onload=ev=>{
    ev.target.result.split(/\r?\n/).slice(1).forEach(row=>{
      const[nm,num]=row.split(','); if(nm&&num) leads.push({nome:nm.trim(),numero:num.trim(),status:'novo'});
    });
    saveLeads(); renderKanban();
  }; r.readAsText(f);
};
/* ---------- Paste contacts ---------- */
btnPaste.onclick=()=>{ modalPaste.style.display='flex'; pasteText.value=''; pastePreview.textContent=''; pasteSave.disabled=true; };
pasteCancel.onclick=()=>modalPaste.style.display='none';
pasteText.oninput=()=>{
  const list=parseContacts(pasteText.value);
  pastePreview.textContent=list.map(c=>c.nome+' ‚Äì '+c.numero).join('\n');
  pasteSave.disabled=!list.length;
  pasteSave.dataset.data=JSON.stringify(list);
};
pasteSave.onclick=()=>{
  const list=JSON.parse(pasteSave.dataset.data||'[]');
  list.forEach(c=>leads.push({...c,status:'novo'})); saveLeads(); renderKanban(); modalPaste.style.display='none';
};
function parseContacts(t){
  return t.split(/\r?\n/).map(l=>l.trim()).filter(Boolean).map(l=>{
    const digits=l.replace(/\D/g,''); if(digits.length<10) return null;
    let num=digits; if(num.startsWith('55')&&num.length>11) num=num.slice(2);
    if(num.length>11) num=num.slice(-11);
    let nome=l.replace(/[0-9,.;\s]+/g,' ').replace(/\s+/g,' ').trim(); if(!nome) nome='Contato '+num.slice(-4);
    return {nome,numero:num};
  }).filter(Boolean);
}
/* ---------- Etapas modal ---------- */
btnEtapas.onclick=()=>{ refreshEtapasModal(); modalEtapas.style.display='flex'; };
function refreshEtapasModal(){
  etapasLista.innerHTML='';
  stages.forEach((s,i)=>{
    const row=document.createElement('div');
    row.innerHTML=\`<input value="\${s.label}" data-i="\${i}">\${i?'<button class="btn-danger" onclick="remEtapa('+i+')">üóëÔ∏è</button>':''}\`;
    etapasLista.appendChild(row);
  });
}
function remEtapa(i){ stages.splice(i,1); refreshEtapasModal(); }
btnNovaEtapa.onclick=()=>{ stages.push({id:slug('etapa'+Date.now()),label:'‚ùî Nova Etapa'}); refreshEtapasModal(); };
etapasCancel.onclick=()=>modalEtapas.style.display='none';
etapasSave.onclick=()=>{
  etapasLista.querySelectorAll('input').forEach(inp=>{
    const i=inp.dataset.i; stages[i].label=inp.value.trim(); stages[i].id=slug(stages[i].label);
  });
  saveStages(); modalEtapas.style.display='none'; renderKanban();
};
/* ---------- Agenda modal ---------- */
const templates={
central:`Ol√° {nome}, tudo certo?

Passando s√≥ pra confirmar a sua visita √† nossa Central de Vendas Direcional, localizada na Av. Maria Em√≠lia A. dos Santos de Angelis, 485 ‚Äì Parque Prado, Campinas ‚Äì SP, 13044-163.

üïí Hor√°rio agendado: {dataHora}
üìç Link do local no Google Maps:
üëâ https://maps.app.goo.gl/3ayKMC2bF8hJL8TK9

Ao chegar, pe√ßa para falar com o William.

Aqui voc√™ poder√° conhecer todos os nossos projetos dispon√≠veis, simular condi√ß√µes exclusivas e tirar suas d√∫vidas pessoalmente.

Qualquer d√∫vida ou imprevisto, me avisa por aqui.
Te espero na recep√ß√£o! üòâ`,
seleto:`Ol√° {nome}, tudo certo?

Passando s√≥ pra confirmar a sua visita ao Seleto Amoreiras, localizado na R. Joaquim Lacerda Coelho, 647 ‚Äì Jardim Capivari, Campinas ‚Äì SP, 13050-800.

üïí Hor√°rio agendado: {dataHora}
üìç Link do local no Google Maps:
üëâ https://maps.app.goo.gl/Rgs2wBWEGY1F3qwR8

Ao chegar, pe√ßa para falar com the William.

O Seleto Amoreiras oferece:
‚úî 2 dormit√≥rios
‚úî Varanda gourmet com ponto para churrasqueira
‚úî Lazer completo com piscina, coworking, academia, pet place, sal√£o de festas e muito mais

Qualquer d√∫vida ou imprevisto, √© s√≥ me chamar por aqui.
Te espero no local! üòâ`,
mangara:`Ol√° {nome}, tudo certo?

Confirmando sua visita ao Mangar√° ‚Äì Cores da Mata, localizado na Av. Gra√ßa Aranha, 175 ‚Äì Vila Miguel Vicente Cury, Campinas ‚Äì SP, 13081-542.

üïí Hor√°rio agendado: {dataHora}
üìç Google Maps:
üëâ https://maps.app.goo.gl/rYQrgLtEbRbjXvHZ9

Ao chegar, pe√ßa para falar com o William.

O Mangar√° oferece:
‚úî 2 dormit√≥rios com su√≠te
‚úî Varanda gourmet
‚úî Lazer completo
‚úî Localiza√ß√£o privilegiada em Campinas

Qualquer d√∫vida ou imprevisto, s√≥ me chamar por aqui.
Te espero no local! üòâ`,
alentejo:`Ol√° {nome}, tudo certo?

Confirmando sua visita ao Alentejo Residencial, na Av. Gra√ßa Aranha, 175 ‚Äì Vila Miguel Vicente Cury, Campinas ‚Äì SP, 13081-542.

üïí Hor√°rio agendado: {dataHora}
üìç Google Maps:
üëâ https://maps.app.goo.gl/rYQrgLtEbRbjXvHZ9

Ao chegar, pe√ßa para falar com o William.

O Alentejo oferece:
‚úî 2 e 3 dormit√≥rios
‚úî Varanda gourmet
‚úî Garagem proporcional
‚úî Fechadura eletr√¥nica e Wi-Fi nas √°reas comuns

Qualquer coisa, estou √† disposi√ß√£o.
Te espero no local! üòâ`,
algarve:`Ol√° {nome}, tudo certo?

Confirmando sua visita ao Algarve Residencial, localizado na Av. Gra√ßa Aranha, 175 ‚Äì Vila Miguel Vicente Cury, Campinas ‚Äì SP, 13081-542.

üïí Hor√°rio agendado: {dataHora}
üìç Google Maps:
üëâ https://maps.app.goo.gl/rYQrgLtEbRbjXvHZ9

Ao chegar, pe√ßa para falar com o William.

O Algarve oferece:
‚úî 2 e 3 dormit√≥rios com op√ß√µes tipo e garden
‚úî Varanda gourmet com ponto para churrasqueira a g√°s
‚úî Lazer completo com piscina, coworking, pet place e mais

Qualquer d√∫vida ou imprevisto, √© s√≥ me chamar por aqui.
Te espero no local! üòâ`,
rise:`Ol√° {nome}, tudo certo?

Passando s√≥ pra confirmar a sua visita ao Rise Condom√≠nio Clube, localizado na Rua Bartir√°, 340 ‚Äì Vila Ip√™, Campinas ‚Äì SP.

üïí Hor√°rio agendado: {dataHora}
üìç Link do local no Google Maps:
üëâ https://maps.app.goo.gl/HZgyx2rGDtFEFcLs7

Ao chegar, pe√ßa para falar com o William.

O Rise oferece:
‚úî 2 dormit√≥rios com varanda gourmet
‚úî Condom√≠nio clube com piscina, coworking, academia, sal√£o de festas, brinquedoteca, pet place e muito mais

Qualquer d√∫vida ou imprevisto, √© s√≥ me chamar por aqui.
Te espero no local! üòâ`
};
function fill(tpl,nome,dataHora){return tpl.replaceAll('{nome}',nome).replaceAll('{dataHora}',dataHora);}
function refreshMsg(){
  const pj=agendaProjeto.value; const dt=agendaData.value; if(!pj||!dt) return;
  agendaMsg.value=fill(templates[pj],window.currentLead,new Date(dt).toLocaleString());
}
agendaProjeto.onchange=refreshMsg; agendaData.oninput=refreshMsg;
agendaCancel.onclick=()=>modalAgendar.style.display='none';
agendaSend.onclick=()=>{
  if(!agendaMsg.value.trim()){alert('Mensagem vazia');return;}
  window.open('https://wa.me/?text='+encodeURIComponent(agendaMsg.value),'_blank');
  modalAgendar.style.display='none';
};
/* ---------- Search ---------- */
search.oninput=()=>renderKanban();
/* ---------- Initial render ---------- */
renderKanban();
</script>
</body>
</html>
